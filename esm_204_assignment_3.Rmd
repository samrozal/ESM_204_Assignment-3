---
title: "Distributional Consequences of Climate Policy- ESM 204 Assignment 3"
author: "Sam Rozal, Hollie Pennington, Abigail Sanford"
date: "May 12th, 2022"
output:
  html_document:
    code_folding: hide
---

```{r setup, include = TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(rootSolve)
library(janitor)
library(here)
```

```{r}
df <- read_csv(here("data","HW3_data.csv")) %>% 
  select(-1) %>% 
  clean_names()
```
Last year, the Biden Administration assembled an Inter-agency Working Group (IWG) tasked with updating the United States Government’s Social Cost of Carbon (SCC), which has not been comprehensively updated since 2010. The Administration has also called on government agencies to address environmental justice, racism, and equity concerns when considering policies designed to mitigate climate change.

While the Interagency Working Group develops a new SCC, the Biden Administration’s “interim” value is $51 per metric ton of CO2. The electricity sector is the second largest source of greenhouse gas emissions in the U.S. (after transportation). In this homework, you will consider the distributional consequences of imposing a household electricity tax based on the SCC to address the climate change problem.

We recommend using R and writing functions to compute your answers wherever possible. Use the following set of facts:

• Consumers can be separated into two income groups: “high” and “low.” The data set provides
price (in $) and quantity (in kWh) estimates of demand per month for the two groups. Run
linear regressions (with an intercept) to estimate the demand curves for “high” and “low”
income consumers.
• Initially, there is no tax on electricity consumption.
• The current electricity price (without any taxes) is $.10 per kWh.
• The marginal cost of producing a kWh of electricity is linear and has a price-intercept of 0.


# Question 1

One kWh of electricity emits 0.85 pounds of CO2. Assuming that the interim SCC correctly
reflects the total social cost of one metric ton of CO2, what is the marginal external cost per kwH of electricity?

To find the MEC we use metric conversion to go from $/ton to cents/kWh:

- (5,100 cents/ 1 metric ton)(1 metric ton/2,205 lbs)(0.85lbs/1kWh)= 1.96 cents/kWh

The marginal external social cost of carbon is **$0.02/kWh**

# Question 2

What is the aggregate monthly demand curve for electricity? What is the supply curve for 
electricity? What is the “benefit” to consumers under the status quo? What is the “benefit” to 
producers under the status quo? What is the environmental cost under the status quo?

```{r}
model_demand_l <- lm(price_cents  ~ q_low_kwh, data=df)
model_demand_h <- lm(price_cents ~ q_high_kwh, data=df)
```

```{r}
summary(model_demand_l)
summary(model_demand_h)
```
Equation of lines:

- Low income demand curve: P = 23.4 - 0.00011Q

- High income demand curve: P= 31.6 - 0.000052Q

- Aggregate demand: P = 31.6 - 0.000052Q [Q<], P= 

```{r}
# need to rearrange the parameter to get Q(P)! 
#Qgg = Qlow(P) + Qlow(h) 

# Importantly, since they-intercepts are different, we know that Qagg(P) will have a kink. I include an ifelse() statement to take
# care of the kink.
```


```{r}
# define a function to get demand

demand <- function(p, model){
  q <- (p - model$coefficients[[1]])/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)
  return(q)
}
```


```{r}
# for each p level, return estimated aggregate demand
demand_agg <- function(p){
  q <- demand(p, model_demand_l) + demand(p, model_demand_h)
  return(q)
}
```


```{r}
demand_indv<- function(p, model){
  q <- (p - model$coefficients[[1]])/model$coefficients[[2]]
  return(q)
}
```


```{r}
price_low = seq(0, 23.3, length.out = 100)
demand_low <- demand(price_low, model_demand_l)

low_demand <- map(price_low,demand_low) %>% unlist()

df_2 <- tibble(demand_low = demand_low, price_low = price_low)

ggplot(df_2, aes(demand_low, price_low)) +
  geom_line()
  
```

```{r}
price_high = seq(0, 31.6, length.out = 100)
demand_high <- demand(price_high, model_demand_h)

high_demand <- map(price_high,demand_high) %>% unlist()

df_3 <- tibble(demand_high = demand_high, price_high = price_high)

ggplot(df_2, aes(demand_high, price_high)) +
  geom_line()
```


```{r}
price = seq(0, 31.6, length.out = 100)
Qagg <- map(price, demand_agg) %>% unlist()

df<- tibble(Qagg = Qagg, price = price)

ggplot(df, aes(Qagg, price)) +
  geom_line()

```

```{r}
# Calculate the supply curve for electricity. We know the current price is $0.10/kWh, and the MC electricity curve is linear and will pass through the 0 intercept. 
# Therefore, the slope of the supply curve can be found by doing (y2-y1/x2-x2) using the points (0,0) and (demand_agg(10),10). The zeros cancel out so we get:

mpc_slope <- (10/(demand_agg(10)))
mpc_slope

supply_p <- function(q){
  p <- mpc_slope*q
  return(q)
}

supply_q <- function(p){
  q <- (p/mpc_slope)
  return(q)
}
```
```{r}
demand_agg(10)
```


```{r}
supply_price = seq(0, 31.6, length.out = 100)
q_supply <- supply_q(price_high)

supply_something<- map(price_high,q_supply) %>% unlist()

df_4 <- tibble(q_supply = q_supply, supply_price = supply_price)

ggplot(df_4, aes(q_supply,supply_price)) +
  geom_line()

```


```{r}
ggplot() +
  geom_line(df, mapping=aes(Qagg, price, color = "blue"))+
  geom_line(df_2, mapping=aes(demand_low,price_low, color = "purple")) +
  geom_line(df_3, mapping=aes(demand_high,price_high, color = "red")) + 
  geom_line(df_4, mapping=aes(q_supply,supply_price, color = "yellow"))+
  scale_color_manual(values = c('red', 'blue', 'purple', 'green')) +
  ylim(0,50) + 
  xlim(0,1000000)+
  labs(x = "Quantity of Electricty (kWh)",
       y = "Price per kWh",
       title = "Monthly Demand Curve for Electricity") + 
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5))
```


```{r}
#Find the q free market value at the market equilibrium point 
#We know that the free market is at equilibrium where p=10, because the current cost of electricity is 10 cents/kwh
Q_f <- demand_agg(10)
P_f <- 10
```

```{r}
# I also define functions for calculating the consumer surplus:

CS <- function(p, model){
  q <- demand(p, model)
  cs <- 0.5*(model$coefficients[[1]] - p)*q
  return(cs)
}

CS_agg <- function(p){
  cs <- CS(p,model_demand_l) + CS(p,model_demand_h)
  return(cs)
}
```


```{r}
#calculate benefit to consumers under status quo"

consumer_surplus_low <- CS(10,model_demand_l)
consumer_surplus_high <- CS(10,model_demand_h)

consumer_surplus_low
consumer_surplus_high

consumer_surplus_agg <- CS_agg(10)
consumer_surplus_agg

```

```{r}
#function for MPC
MPC<- function(q){
  p <- mpc_slope*q
  return(p)
}

PS <- function(q){
  ps <- 0.5*(MPC(q))*q
  return(ps)
}

```

```{r}
supply_q(10)
PS(536719.5)
producer_surplus_f <- PS(supply_q(10))
producer_surplus_f

```

```{r}
#environmental cost 
environmental_cost <- Q_f*1.8
environmental_cost
```
# Question 3

Dude IDK what the flying fuck this question is asking...I'm gonna do number 4 instead right now because my brain is like "nah, nope" to this question right now...

# Question 4
4. Derive the optimal electricity tax (in cents per kWh) using the interim SCC. Noting that recent
research has shown the poor face a disproportionate share of the impacts from climate change, assume that the climate externality is borne entirely by the “low” income group. What would be the effects of this tax on:
(a) The amount of electricity produced and consumed
(b) The price of electricity
(c) Overall welfare of “high” income consumers
(d) Overall welfare of “low” income consumers
(e) Power suppliers (i.e., electricity producers)
(f) Total environmental damage
(g) Total tax revenue generated

```{r}
#First we need to find the marginal social cost including the externality 

#the optimal tax is equal to the MEC. Therefore the Marginal social cost is just 1.96 cents

#Shift the aggregate demand curve down to account for tax. 


demand_p_t <-function(q,model){
  p <- (model$coefficients[[1]])- 1.96 + (model$coefficients[[2]]*q)+
  return(p)
}

```

```{r}
demand_p <- function(q,model,t){
  p <- (q*model$coefficients[[2]])+ (model$coefficients[[1]]-t)
}

#demand_new_low <- function(p, model){
 # q <- (p - (model$coefficients[[1]]-t))/model$coefficients[[2]]
  #q <- ifelse(q<0,0,q)
  #return(q)
#}   

demand_new<- function(p, model){
  q <- (p - (model$coefficients[[1]]-1.96))/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)
  return(q)
}   

demand_agg_new <- function(p){
  q <- demand_new(p, model_demand_l) + demand_new(p, model_demand_h)
  return(q)
}

demand_agg_new_eq <- function(q)(demand_new_low(p, model_demand_l) + demand(p, model_demand_h))

```

```{r}
price_new = seq(0, 29.5, length.out = 100)
Qagg_new <- map(price_new, demand_agg_new) %>% unlist()

df_new <- tibble(Qagg_new = Qagg_new, price_new = price_new)
```

```{r}
ggplot()+
  geom_line(df_new, mapping=aes(Qagg_new,price_new, color = "yellow"))
```

```{r}
#testing the new demand curve to make sure its ok

price_new = seq(0, 31.6, length.out = 100)
Qagg_new <- map(price_new, demand_agg_new) %>% unlist()

df_5 <- tibble(Qagg_new = Qagg_new, price_new = price_new)

ggplot(df_5, aes(Qagg_new, price_new)) +
  geom_line()

```

```{r}
#map the new damnd curve and the old demand curve to make sure I did
ggplot() +
  geom_line(df, mapping=aes(Qagg, price, color = "Old Agg Demand"))+
  geom_line(df_new, mapping=aes(Qagg_new, price_new, color = "New Agg demand")) +
  scale_color_manual(values = c('red', 'blue')) +
  ylim(0,50) + 
  xlim(0,1000000)+
  labs(x = "Quantity of Electricty (kWh)",
       y = "Price per kWh",
       title = "Monthly Demand Curve for Electricity") + 
  theme_minimal()
```
```{r}

price = seq(0, 31.6, length.out = 100)
Qagg_new <- map(price, demand_agg_new) %>% unlist()

df_new<- tibble(Qagg_new = Qagg_new, price = price)

ggplot(df, aes(Qagg_new, price)) +
  geom_line()

```


```{r}
mpc_eq <- function(q)(mpc_slope*q)
```


```{r}
#create data frames for the MPC equation and the new demand curve function
```


# Restarting Question 4 becsue I spent 2 hours doing wrong stuff but I'm too emotionally attached to the wrong code that I can't bring myself to delete it yet.
4. Derive the optimal electricity tax (in cents per kWh) using the interim SCC. Noting that recent
research has shown the poor face a disproportionate share of the impacts from climate change, assume that the climate externality is borne entirely by the “low” income group. What would be the effects of this tax on:
(a) The amount of electricity produced and consumed
(b) The price of electricity
(c) Overall welfare of “high” income consumers
(d) Overall welfare of “low” income consumers
(e) Power suppliers (i.e., electricity producers)
(f) Total environmental damage

```{r}

supply_p <- function(q){
  p <- mpc_slope*q
  return(p)
}

supply_q <- function(p){
  q <- (p/mpc_slope)
  return(q)
}

```


```{r}
# First I need to find the new demand curve by shifting the aggreh=get demand cueve down by the optimal tax

demand-supply
uniroot(function_you_write, c(0,600000))$root
```

```{r}
equilibrium_pt_free <- function(p)((demand(p, model_demand_l) + demand(p, model_demand_h))-(p/mpc_slope))
uniroot(equilibrium_pt, c(0,600000))$root
```

